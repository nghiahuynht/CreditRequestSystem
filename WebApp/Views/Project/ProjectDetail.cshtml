@using System.Globalization
@{
    ViewData["Title"] = "Thông tin dự án/chương trình/dịch vụ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model DAL.Models.ProjectFinancialSummar.ProjectFinancialSummarViewModel

<input hidden id="projectId" value="@Model.ProjectInfo.Id" />
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>@(ViewData["Title"])</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    @*<li class="breadcrumb-item">
                            <input type="button" value="Lưu" class="btn bg-primary" id="btn-save" onclick="CreateProject()" />
                        </li>*@

                </ol>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>
<section class="content">
    <div class="card card-warning card-outline card-tabs">
        <div class="card-header p-0 pt-1 border-bottom-0">
            <ul class="nav nav-tabs" id="custom-tabs-three-tab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="project-detail-tab" data-toggle="pill" href="#project-detail-tab-content" role="tab" aria-controls="custom-tabs-three-home" aria-selected="true">THÔNG TIN CHƯƠNG TRÌNH/DỰ ÁN/DỊCH VỤ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="project-history-tab" data-toggle="pill" href="#project-history-tab-content" role="tab" aria-controls="custom-tabs-three-messages" aria-selected="false">LỊCH SỬ ĐIỀU CHỈNH</a>
                </li>



            </ul>
        </div>
        <div class="card-body">

            <div class="tab-content">
                <div class="tab-pane fade active show" id="project-detail-tab-content" role="tabpanel" aria-labelledby="custom-tabs-three-home-tab">
                    <fieldset class="border rounded-1 pb-3 pe-3 ps-3 mb-3">
                        <legend class="float-none w-auto px-3 text-uppercase fw-bold fs-2 mb-0 text-blue">Thông tin tổng quát</legend>
                        <form class="form-horizontal" id="frmCreateProject">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Thời gian thực hiện</label>
                                        <div class="input-group-append col-md-8">
                                            <input type="date" class="form-control" value="@Model.ProjectInfo.TimeStart?.ToString("yyyy-MM-dd")" name="thoi_gian_bat_dau" id="a_thoi_gian_bat_dau" readonly/>
                                            <h3>-</h3>
                                            <input type="date" class="form-control" value="@Model.ProjectInfo.TimeEnd?.ToString("yyyy-MM-dd")" name="thoi_gian_ket_thuc" id="a_thoi_gian_ket_thuc" readonly/>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Mã dự án <span class="text-red">*</span></label>
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" value="@Model.ProjectInfo.ProjectCode" name="ma_du_an" id="a_ma_du_an" readonly />
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Tên dự án <span class="text-red">*</span></label>
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" id="a_ten_du_an" name="ten_du_an" value="@Model.ProjectInfo.ProjectName" readonly />
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Căn cứ pháp lý <span class="text-red">*</span></label>
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" id="a_can_cu_phap_ly" name="can_cu_phap_ly" value="@Model.ProjectInfo.LegalBasis" readonly />
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Người tạo</label>
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" value="admin" disabled="disabled" />
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Ngày tạo</label>
                                        <div class="col-md-8">
                                            <div class="input-group date">
                                                <input type="text" id="DateRequest" disabled="disabled" name="DateRequest" value="@DateTime.Now.ToString("dd/MM/yyyy")" class="form-control">
                                                <span class="input-group-addon group-date-icon"><i class="far fa-calendar-alt"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-6">

                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Tổng hạn mức <span class="text-red">*</span></label>
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" style="font-weight:bold;" name="tong_han_muc" id="a_tong_han_muc" value="@Model.ProjectInfo.TotalAmount" readonly />
                                        </div>
                                    </div>
                                    @*<div class="form-group row">
                                        <label class="col-md-4 col-form-label">Đã sử dụng (luỹ kế)</label>
                                        <div class="col-md-7">
                                            <input type="text" id="a_luy_ke" data-value="show" class="form-control" disabled="disabled" style="font-weight:bold;" value="0" />
                                        </div>
                                        <div class="col-md-1">
                                            <span onclick="showhideSoTienDaSuDung()" class="fa fa-eye" style="font-size:16pt;" id="icon_show_hide"></span>
                                        </div>
                                    </div>*@
                                    <div class="form-group row">
                                        <label class="col-md-4 col-form-label">Ghi chú</label>
                                        <div class="col-md-8">
                                            <textarea class="form-control" id="a_ghi_chu" rows="3" readonly></textarea>
                                        </div>
                                    </div>
                                    @*<div class="form-group row">
                                        <label class="col-md-4 col-form-label">Trạng thái</label>
                                        <div class="col-md-8">
                                            <span class='badge badge-primary badge-status' id="a_trang_thai">Đang hiệu lực</span>
                                        </div>
                                    </div>*@
                                    <div class="form-group row">
                                        <div class="col-md-4 pt-3">

                                            <!--<input type="button" value="Đính kèm" class="btn btn-warning" onclick="UploadFileProject()" />-->
                                            <!-- Input file ẩn -->
                                            <!--<input type="file" id="fileInputProject" style="display: none;" />-->
                                        </div>
                                        <div class="col-md-8">
                                            <table class="table" width="100%" id="table_Attact_File">
                                                @foreach (var file in Model.ListFileAttach)
                                                {
                                                    <tr>
                                                        <td width="40px" style="text-align:center;">
                                                            <a>
                                                                <span class="fa fa-download"></span>
                                                            </a>
                                                        </td>
                                                        <td>
                                                            <a href="@file.URLPath" target="_blank">@file.FileName</a>
                                                        </td>

                                                    </tr>
                                                }
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </fieldset>

                    <fieldset class="border rounded-1 pb-3 pe-3 ps-3 mb-3" id="regon_hang_muc_phan_bo" style="display:block">
                        <legend class="float-none w-auto px-3 text-uppercase fw-bold fs-2 mb-0 text-blue">Hạng mục phân bổ chi tiết</legend>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Nhóm hoạt động</th>
                                    <th>Mục chi</th>
                                    <th>Tiêu chuẩn</th>
                                    <th>SL</th>
                                    <th>Đơn giá</th>
                                    <th>Thành tiền</th>
                                    <th>Ghi chú</th>
                                    <th width="90px"></th>
                                </tr>
                            </thead>
                            <tbody id="table_phan_bo_chi_tiet">
                                @foreach (var detail in Model.ListProjectDetail)
                                {
                                    <tr data-id="@detail.Id">
                                        <td>@detail.ActivityGroupName</td>
                                        <td>@detail.ExpenseId</td>
                                        <td>@detail.Standard</td>
                                        <td>@detail.Quantity</td>
                                        <td>@detail.Price?.ToString("N0", new CultureInfo("de-DE"))</td>
                                        <td>@detail.TotalAmount?.ToString("N0", new CultureInfo("de-DE"))</td>
                                        <td>@detail.Notes</td>
                                        <td style="text-align:center;">
                                            <span class="fa fa-eye" onclick="ViewDetail(@detail.Id)"></span>&nbsp;
                                            <span class="fa fa-trash" onclick="RemoveProjectDetail(@detail.Id)"></span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </fieldset>






                </div>
                <div id="project-history-tab-content" class="tab-pane fade">
                    <br />
                    <table class="table table-bordered">
                        <tr style="background:#f4f4f4;">
                            <th>Lần</th>
                            <th>Tên</th>
                            <th>Căn cứ pháp lý</th>
                            <th>Thời gian thực hiện</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                            <th>Ghi chú</th>
                            <th>Người chỉnh</th>
                            <th>Ngày chỉnh</th>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>Dự án dự toán kinh phí tổ chức hội thảo</td>
                            <td>Quyết định 124/QĐ</td>
                            <td>2024-2025</td>
                            <td>500,000,000</td>
                            <th><span class='badge badge-primary badge-status'>Đang hiệu lực</span></th>
                            <td>Năm 2025: 50.000.000</td>
                            <td>Admin</td>
                            <td>13/11/2024</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Dự án dự toán kinh phí tổ chức hội thảo</td>
                            <td>Quyết định 6/QĐ</td>
                            <td>2024-2025</td>
                            <td>450,000,000</td>
                            <th><span class='badge badge-primary badge-status'>Đang hiệu lực</span></th>
                            <td>Năm 2025: 50.000.000</td>
                            <td>Admin</td>
                            <td>13/11/2024</td>
                        </tr>
                    </table>
                </div>
            </div>


        </div>
    </div>
</section>


<div class="modal fade show" data-backdrop="static" id="modal-project-itemline" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-xl" id="modal-hang-muc-phan-bo">

    </div>

</div>

@section scripts{
    <!-- Thêm jQuery Validate -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>

    <script>
        var listFileAttact = [];
        $(document).ready(function () {
            formatTotalAmount();
            $("#btn-add-project-item").click(function () {
                $.ajax({
                    url: '/Project/FormCreateProjectDetail',
                    type: 'GET',
                    data: {},
                    contentType: 'application/json',
                    success: function (response) {
                        $('#modal-hang-muc-phan-bo').html("");
                        $('#modal-hang-muc-phan-bo').append(response);
                        $("#modal-project-itemline").modal();
                    },
                    error: function (xhr, status, error) {

                        alert('Có lỗi khi gửi yêu cầu!');
                    }
                });


            });

            // Khi người dùng chọn file
            $('#fileInputProject').on('change', function () {

                const file = this.files[0]; // Lấy file được chọn
                if (file) {
                    // Upload file
                    const fileData = new FormData();
                    fileData.append('file', this.files[0]);

                    $.ajax({
                        url: '/FileUpload/UploadFile', // Đường dẫn đến API xử lý file
                        type: 'POST',
                        data: fileData,
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            if (response.success == true && response.fileNameAttactId > 0) {
                                const html = `
                                                    <tr>
                                                        <td width="40px" style="text-align:center;">
                                                            <a  target="_blank">
                                                                <span class="fa fa-download"></span>
                                                            </a>
                                                        </td>
                                                        <td>
                                                            <a href="${response.filePath}" target="_blank">${response.fileName}</a>
                                                        </td>
                                                         <td width="40px" style="text-align:center;color:crimson;">
                                                            <span class="fa fa-trash delete-file"
                                                                  data-id="${response.fileNameAttactId}"
                                                                  style="cursor:pointer;"
                                                                  onclick="RemoveFile(${response.fileNameAttactId})"></span>
                                                        </td>
                                                    </tr>
                                                `;

                                $('#table_Attact_File').append(html)
                            }
                            listFileAttact.push(response.fileNameAttactId)
                            toastr.success('Tải file thành công!', 'Thành công', { positionClass: "toast-top-center" });
                        },
                        error: function () {
                            toastr.error('Có lỗi khi tải file!', 'Lỗi', { positionClass: "toast-top-center" });
                        }
                    });
                }
            });
        });

        function RemoveFile(fileId) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: "Bạn sẽ không thể hoàn tác hành động này!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $(`span[data-id="${fileId}"]`).closest('tr').remove();
                    listFileAttact = listFileAttact.filter(x => x != fileId);
                    toastr.success('Xóa file thành công!', 'Thành công');
                }
            });
        }

        function CreateProject() {

            var isValidate = validateData();

            if (isValidate == true) {

                var dataPost = {
                    Id: 0,
                    ProjectCode: $("#a_ma_du_an").val(),
                    ProjectName: $("#a_ten_du_an").val(),
                    LegalBasis: $("#a_can_cu_phap_ly").val(),
                    TimeStart: $("#a_thoi_gian_bat_dau").val(),
                    TimeEnd: $("#a_thoi_gian_ket_thuc").val(),
                    TotalAmount: $("#a_tong_han_muc").val(),
                    StatusText: document.getElementById("a_trang_thai").innerText,
                    Notes: $("#a_ghi_chu").val(),
                    FileAttach: listFileAttact
                };
                // Gửi yêu cầu AJAX
                console.log("dataPost", dataPost);
                $.ajax({
                    url: '/Project/CreateProjectFinancialSummar',
                    type: 'POST',
                    data: JSON.stringify(dataPost),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.success) {
                            console.log(response)
                            toastr.success('Dự án đã được tạo thành công!', 'Thành công', { positionClass: "toast-top-center" });
                            $("#projectId").val(response.projectId);
                            document.getElementById("regon_hang_muc_phan_bo").style.display = "block";

                        } else {
                            toastr.error('Có lỗi khi tạo dự án. Vui lòng thử lại!', 'Lỗi', { positionClass: "toast-top-center" });
                        }
                    },
                    error: function (xhr, status, error) {
                        // Xử lý khi có lỗi xảy ra trong quá trình gọi AJAX
                        alert('Có lỗi khi gửi yêu cầu!');
                    }
                });
            }
        }

        function UploadFileProject() {
            $('#fileInputProject').click();
        }

        function validateData() {
            var resultValid = $("#frmCreateProject").validate({
                rules: {
                    "ten_du_an": {
                        required: true,
                    },
                    "ma_du_an": {
                        required: true,
                    },
                    "can_cu_phap_ly": {
                        required: true,
                    },
                    "thoi_gian_bat_dau": {
                        required: true,
                    },
                    "thoi_gian_ket_thuc": {
                        required: true,
                    },
                    "tong_han_muc": {
                        required: true,
                        number: true,
                        min: 1
                    },

                },
                messages: {
                    "ten_du_an": "Tên chương trình/dự án/dịch vụ không được để trống!",
                    "ma_du_an": "Mã chương trình/dự án/dịch vụ không được để trống!",
                    "can_cu_phap_ly": "Căn cứ pháp lý không được để trống!",
                    "thoi_gian_bat_dau": "Thời gian thực hiện không được để trống!",
                    "thoi_gian_ket_thuc": "Thời gian thực hiện không được để trống!",
                    "tong_han_muc": {
                        required: "Tổng tiền không được để trống!",
                        number: "Tổng tiền phải là số!",
                        min: "Tổng tiền phải lớn hơn 0!"
                    }
                },

            }).form();

            return resultValid;
        }

        function showhideSoTienDaSuDung() {
            var ishow = document.getElementById("a_luy_ke").getAttribute("data-value");
            var iconElement = document.getElementById("icon_show_hide");
            if (ishow == "show") {
                document.getElementById('a_luy_ke').type = 'password';
                document.getElementById("a_luy_ke").setAttribute('data-value', 'hide');
                iconElement.classList.remove('fa-eye');
                iconElement.classList.add('fa-eye-slash');
            } else {
                document.getElementById('a_luy_ke').type = 'text';
                document.getElementById("a_luy_ke").setAttribute('data-value', 'show');
                iconElement.classList.remove('fa-eye-slash');
                iconElement.classList.add('fa-eye');
            }
        }

        //-----DETAIL------//
        function CreateProjectDetail() {

            var isValidateDetail = validateDataDetail();
            if (isValidateDetail == true) {
                if ($("#projectId").val() == "" || $("#projectId").val() == undefined) {
                    toastr.error('ProjectId null. Vui lòng thử lại!', 'Lỗi', { positionClass: "toast-top-center" });
                    return;
                }
                var dataPost = {
                    Id: parseInt($("#ProjectDetailId").val()),
                    ProjectId: parseInt($("#projectId").val()),
                    ActivityGroupId: parseInt($("#a_nhom_hoat_dong").val()),
                    ExpenseItem: $("#a_muc_chi").val(),
                    Standard: $("#a_tieu_chuan").val(),
                    Quantity: $("#a_so_luong").val() == "" ? 0 : parseInt($("#a_so_luong").val()),
                    Price: $("#a_don_gia_khong_format").val() == "" ? 0 : parseFloat($("#a_don_gia_khong_format").val()),
                    TotalAmount: parseFloat($("#a_thanh_tien_khong_format").val()),
                    Notes: $("#a_ghi_chu_tt_chi_tiet").val(),

                };
                // Gửi yêu cầu AJAX
                console.log("dataPost", dataPost);
                $.ajax({
                    url: '/Project/CreateProjectFinancialDetail',
                    type: 'POST',
                    data: JSON.stringify(dataPost),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.success) {
                            var nhomhoatdongtext = $("#a_nhom_hoat_dong option:selected").text();

                            if (dataPost.Id == 0) {
                                const htmldt = `
                                     <tr data-id=${response.projectDetailId}>
                                        <td>${nhomhoatdongtext}</td>
                                        <td>${dataPost.ExpenseItem}</td>
                                        <td>${dataPost.Standard}</td>
                                        <td>${dataPost.Quantity}</td>
                                        <td>${dataPost.Price}</td>
                                        <td>${dataPost.TotalAmount}</td>
                                        <td>${dataPost.Notes}</td>
                                        <td style="text-align:center;">
                                            <span class="fa fa-eye" onclick="ViewDetail(${response.projectDetailId})"></span>&nbsp;
                                             <span class="fa fa-edit" onclick="EditProjectDetail(${response.projectDetailId})"></span>&nbsp;
                                             <span class="fa fa-trash" onclick="RemoveProjectDetail(${response.projectDetailId})"></span>
                                        </td>
                                    </tr>
                                    `;
                                $('#table_phan_bo_chi_tiet').append(htmldt);
                            }
                            else {
                                const htmldtUpdate = `
                                        <td>${nhomhoatdongtext}</td>
                                        <td>${dataPost.ExpenseItem}</td>
                                        <td>${dataPost.Standard}</td>
                                        <td>${dataPost.Quantity}</td>
                                        <td>${dataPost.Price}</td>
                                        <td>${dataPost.TotalAmount}</td>
                                        <td>${dataPost.Notes}</td>
                                        <td style="text-align:center;">
                                             <span class="fa fa-eye" onclick="ViewDetail(${response.projectDetailId})"></span>&nbsp;
                                             <span class="fa fa-edit" onclick="EditProjectDetail(${response.projectDetailId})"></span>&nbsp;
                                             <span class="fa fa-trash" onclick="RemoveProjectDetail(${response.projectDetailId})"></span>
                                        </td>
                                    `;
                                $(`#table_phan_bo_chi_tiet tr[data-id="${dataPost.Id}"]`).html(htmldtUpdate);
                            }

                            toastr.success('Thông tin chi tiết đã tạo thành công!', 'Thành công', { positionClass: "toast-top-center" });
                            $('#modal-hang-muc-phan-bo').html("");
                            $('#modal-project-itemline').modal("hide");

                        } else {
                            toastr.error('Có lỗi khi tạo thông tin chi tiết. Vui lòng thử lại!', 'Lỗi', { positionClass: "toast-top-center" });
                        }
                    },
                    error: function (xhr, status, error) {
                        // Xử lý khi có lỗi xảy ra trong quá trình gọi AJAX
                        alert('Có lỗi khi gửi yêu cầu!');
                    }
                });
            }
        }

        function validateDataDetail() {
            var resultValid = $("#frmCreateProjectDetail").validate({
                rules: {
                    "nhom_hoat_dong": {
                        required: true,
                    },
                    "muc_chi": {
                        required: true,
                    },
                    "so_luong": {
                        required: false,
                        number: true,
                        min: 0
                    },

                    "thanh_tien": {
                        required: true
                    }

                },
                messages: {
                    "nhom_hoat_dong": "Nhóm hoạt động không được để trống!",
                    "muc_chi": "Mục chi không được để trống!",
                    "so_luong": {
                        number: "Tổng tiền phải là số!"
                    },

                    "thanh_tien": {
                        required: "Thành tiền không được để trống!"
                    }
                },

            }).form();

            return resultValid;

        }

        function RemoveProjectDetail(projectDetailId) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: "Bạn sẽ không thể hoàn tác hành động này!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // call ajax
                    $.ajax({
                        url: '/Project/DeleteProjectDetail',
                        type: 'GET',
                        data: { Id: projectDetailId },
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.success) {
                                $(`#table_phan_bo_chi_tiet tr[data-id="${projectDetailId}"]`).remove();

                                toastr.success('Xóa file thành công!', 'Thành công', { positionClass: "toast-top-center" });
                            }
                            else {
                                toastr.error('Xóa file thất bại!', 'Lỗi', { positionClass: "toast-top-center" });
                            }
                        },
                        error: function (xhr, status, error) {

                            alert('Có lỗi khi gửi yêu cầu!');
                        }
                    });

                }
            });
        }

        function EditProjectDetail(projectDetailId) {
            $.ajax({
                url: '/Project/FormCreateProjectDetail',
                type: 'GET',
                data: { Id: projectDetailId },
                contentType: 'application/json',
                success: function (response) {
                    $('#modal-hang-muc-phan-bo').html("");
                    $('#modal-hang-muc-phan-bo').append(response)
                    $("#modal-project-itemline").modal();
                },
                error: function (xhr, status, error) {

                    alert('Có lỗi khi gửi yêu cầu!');
                }
            });
        }

        function ViewDetail(projectDetailId) {
            $.ajax({
                url: '/Project/FormViewDetailProjectDetail',
                type: 'GET',
                data: { Id: projectDetailId },
                contentType: 'application/json',
                success: function (response) {
                    $('#modal-hang-muc-phan-bo').html("");
                    $('#modal-hang-muc-phan-bo').append(response);
                    $("#modal-project-itemline").modal();
                },
                error: function (xhr, status, error) {

                    alert('Có lỗi khi gửi yêu cầu!');
                }
            });
        }

        function AddFormPaymentProfile() {
            // Generate a unique random number
            var randomId = Date.now();
            var htmthstt = ` <tr >
                                <td>
                                    <input name="ma_hs_thanh_toan" id="a_ma_hs_thanh_toan"  class="form-control"/>
                                </td>
                                <td>
                                    <input name="ten_hs_thanh_toan" id="a_ten_hs_thanh_toan"  class="form-control" />
                                </td>
                                <td>
                                    <input name="ghi_chu_hs_thanh_toan" id="a_ghi_chu_hs_thanh_toan" class="form-control" />
                                </td>
                                <td style="text-align:center;">
                                    <span class="fa fa-check" onclick="SaveProfile(${randomId})"></span>
                                    <span class="fa fa-trash" onclick="RemovePaymentProfile(${randomId})"></span>
                                </td>
                             </tr>`;
            $('#table_thong_tin_hs_thanh_toan').append(htmthstt);
        }

        function SaveProfile(profileId) {

            // Find the row that contains the clicked icon
            var row = $(`span.fa-check[onclick="SaveProfile(${profileId})"]`).closest('tr');

            // Retrieve values from the inputs in the row
            var codeInput = row.find('input[name="ma_hs_thanh_toan"]');
            var nameInput = row.find('input[name="ten_hs_thanh_toan"]');
            var nameNotes = row.find('input[name="ghi_chu_hs_thanh_toan"]');
            var code = row.find('input[name="ma_hs_thanh_toan"]').val();
            var name = row.find('input[name="ten_hs_thanh_toan"]').val();

            // Validation messages
            var errors = [];

            if (!code || code.trim() === "") {
                errors.push("Mã không được để trống!");
            }
            if (!name || name.trim() === "") {
                errors.push("Tên không được để trống!");
            }

            // Display validation errors if any
            if (errors.length > 0) {
                toastr.error(errors.join("<br>"), 'Lỗi', { positionClass: "toast-top-center" });
                return;
            }

            // Prepare the data for submission
            var dataPost = {
                Id: 0,
                ProjectDetailId: $("#PaymentProFileForProjectDetailId").val(),
                ActiveGroupId: $("#ActivityGroupId").val(),
                ProfileId: profileId,
                PaymentInfoCode: code.trim(),
                PaymentInfoName: name.trim(),
                Notes: row.find('input[id="a_ghi_chu_hs_thanh_toan"]').val()?.trim()
            };

            // Log the data (optional for debugging)

            $.ajax({
                url: '/Project/CreateProfileForProjectDetail',
                type: 'POST',
                data: JSON.stringify(dataPost),
                contentType: 'application/json',
                success: function (response) {
                    if (response.success) {
                        // Set inputs to readonly
                        codeInput.prop('readonly', true);
                        nameInput.prop('readonly', true);
                        nameNotes.prop('readonly', true);

                        // Remove the onclick event from the save icon
                        row.find('span.fa-check').remove();
                        toastr.success('Thông tin hồ sơ đã tạo thành công!', 'Thành công', { positionClass: "toast-top-center" });
                    } else {
                        toastr.error('Có lỗi khi tạo thông tin hồ sơ. Vui lòng thử lại!', 'Lỗi', { positionClass: "toast-top-center" });
                    }
                },
                error: function (xhr, status, error) {
                    // Xử lý khi có lỗi xảy ra trong quá trình gọi AJAX
                    alert('Có lỗi khi gửi yêu cầu!');
                }
            });
        }

        function RemovePaymentProfile(profileId) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: "Bạn sẽ không thể hoàn tác hành động này!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // call ajax
                    $.ajax({
                        url: '/Project/DeletePaymentProfileOfProjectDetail',
                        type: 'GET',
                        data: {
                            ProjectDetailId: $("#PaymentProFileForProjectDetailId").val(),
                            ProfileId: profileId
                        },
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.success) {

                                $(`span.fa-trash[onclick="RemovePaymentProfile(${profileId})"]`).closest('tr').remove();
                                toastr.success('Xóa thông tin hồ sơ thành công!', 'Thành công');
                            }
                            else {

                                toastr.error('Xóa thông tin hồ sơ  thất bại!', 'Lỗi');
                            }
                        },
                        error: function (xhr, status, error) {

                            alert('Có lỗi khi gửi yêu cầu!');
                        }
                    });

                }
            });

        }

        function formatTotalAmount() {
            var inputElement = document.getElementById('a_tong_han_muc');
            var value = inputElement.value.trim();
            if (value && !isNaN(value) || value == "0") {
                var rawValue = parseFloat(value);

                var formattedValue = rawValue.toLocaleString('de-DE');
                inputElement.value = formattedValue;
            } else {
                // If invalid, clear both fields
                inputElement.value = '';

            }
        }

        function formatThanhTien() {
            var inputElement = document.getElementById('a_thanh_tien');
            var value = inputElement.value.trim();
            if (value && !isNaN(value) || value == "0") {
                var rawValue = parseFloat(value);
                $('#a_thanh_tien_khong_format').val(rawValue);
                var formattedValue = rawValue.toLocaleString('de-DE');
                inputElement.value = formattedValue;
            } else {
                // If invalid, clear both fields
                inputElement.value = '';

            }
        }

        function formatDonGia() {
            var inputElement = document.getElementById('a_don_gia');
            var value = inputElement.value.trim();
            if (value && !isNaN(value) || value == "0") {
                var rawValue = parseFloat(value);
                $('#a_don_gia_khong_format').val(rawValue);
                var formattedValue = rawValue.toLocaleString('de-DE');
                inputElement.value = formattedValue;
                changeSoLuongDonGia();
            } else {
                // If invalid, clear both fields
                inputElement.value = '';

            }
        }

        function changeSoLuongDonGia() {
            var inputElementSoLuong = document.getElementById('a_so_luong').value.trim();
            var inputElementDonGia = document.getElementById('a_don_gia_khong_format').value.trim();
            if (inputElementSoLuong && !isNaN(inputElementSoLuong) && inputElementDonGia && !isNaN(inputElementDonGia)) {
                var valueSoLuong = parseFloat(inputElementSoLuong);
                var valueDonGia = parseFloat(inputElementDonGia);
                $('#a_thanh_tien').val(valueSoLuong * valueDonGia);
                formatThanhTien();

            }
        }
    </script>
}